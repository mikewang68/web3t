var Buffer = require('safe-buffer').Buffer;
var bech32 = require('bech32');
var bs58check = require('bs58check');
var bscript = require('./script');
var btemplates = require('./templates');
var networks = require('./networks');
var typeforce = require('typeforce');
var types = require('./types');
function fromBase58Check(address) {
    var payload = bs58check.decode(address);
    // TODO: 4.0.0, move to "toOutputScript"
    if (payload.length < 21)
        throw new TypeError(address + ' is too short');
    if (payload.length > 22)
        throw new TypeError(address + ' is too long');
    var multibyte = payload.length === 22;
    var offset = multibyte ? 2 : 1;
    var version = multibyte ? payload.readUInt16BE(0) : payload[0];
    var hash = payload.slice(offset);
    return { version: version, hash: hash };
}
function fromBech32(address) {
    var result = bech32.decode(address);
    var data = bech32.fromWords(result.words.slice(1));
    return {
        version: result.words[0],
        prefix: result.prefix,
        data: Buffer.from(data)
    };
}
function toBase58Check(hash, version) {
    typeforce(types.tuple(types.Hash160bit, types.UInt16), arguments);
    // Zcash adds an extra prefix resulting in a bigger (22 bytes) payload. We identify them Zcash by checking if the
    // version is multibyte (2 bytes instead of 1)
    var multibyte = version > 0xff;
    var size = multibyte ? 22 : 21;
    var offset = multibyte ? 2 : 1;
    var payload = Buffer.allocUnsafe(size);
    multibyte ? payload.writeUInt16BE(version, 0) : payload.writeUInt8(version, 0);
    hash.copy(payload, offset);
    return bs58check.encode(payload);
}
function toBech32(data, version, prefix) {
    var words = bech32.toWords(data);
    words.unshift(version);
    return bech32.encode(prefix, words);
}
function fromOutputScript(outputScript, network) {
    network = network || networks.bitcoin;
    if (btemplates.pubKeyHash.output.check(outputScript))
        return toBase58Check(bscript.compile(outputScript).slice(3, 23), network.pubKeyHash);
    if (btemplates.scriptHash.output.check(outputScript))
        return toBase58Check(bscript.compile(outputScript).slice(2, 22), network.scriptHash);
    if (btemplates.witnessPubKeyHash.output.check(outputScript))
        return toBech32(bscript.compile(outputScript).slice(2, 22), 0, network.bech32);
    if (btemplates.witnessScriptHash.output.check(outputScript))
        return toBech32(bscript.compile(outputScript).slice(2, 34), 0, network.bech32);
    throw new Error(bscript.toASM(outputScript) + ' has no matching Address');
}
function toOutputScript(address, network) {
    network = network || networks.bitcoin;
    var decode;
    try {
        decode = fromBase58Check(address);
    }
    catch (e) { }
    if (decode) {
        if (decode.version === network.pubKeyHash)
            return btemplates.pubKeyHash.output.encode(decode.hash);
        if (decode.version === network.scriptHash)
            return btemplates.scriptHash.output.encode(decode.hash);
    }
    else {
        try {
            decode = fromBech32(address);
        }
        catch (e) { }
        if (decode) {
            if (decode.prefix !== network.bech32)
                throw new Error(address + ' has an invalid prefix');
            if (decode.version === 0) {
                if (decode.data.length === 20)
                    return btemplates.witnessPubKeyHash.output.encode(decode.data);
                if (decode.data.length === 32)
                    return btemplates.witnessScriptHash.output.encode(decode.data);
            }
        }
    }
    throw new Error(address + ' has no matching Script');
}
module.exports = {
    fromBase58Check: fromBase58Check,
    fromBech32: fromBech32,
    fromOutputScript: fromOutputScript,
    toBase58Check: toBase58Check,
    toBech32: toBech32,
    toOutputScript: toOutputScript
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYWRkcmVzcy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9hZGRyZXNzLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLElBQUksTUFBTSxHQUFHLE9BQU8sQ0FBQyxhQUFhLENBQUMsQ0FBQyxNQUFNLENBQUE7QUFDMUMsSUFBSSxNQUFNLEdBQUcsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFBO0FBQzlCLElBQUksU0FBUyxHQUFHLE9BQU8sQ0FBQyxXQUFXLENBQUMsQ0FBQTtBQUNwQyxJQUFJLE9BQU8sR0FBRyxPQUFPLENBQUMsVUFBVSxDQUFDLENBQUE7QUFDakMsSUFBSSxVQUFVLEdBQUcsT0FBTyxDQUFDLGFBQWEsQ0FBQyxDQUFBO0FBQ3ZDLElBQUksUUFBUSxHQUFHLE9BQU8sQ0FBQyxZQUFZLENBQUMsQ0FBQTtBQUNwQyxJQUFJLFNBQVMsR0FBRyxPQUFPLENBQUMsV0FBVyxDQUFDLENBQUE7QUFDcEMsSUFBSSxLQUFLLEdBQUcsT0FBTyxDQUFDLFNBQVMsQ0FBQyxDQUFBO0FBRTlCLFNBQVMsZUFBZSxDQUFFLE9BQU87SUFDL0IsSUFBSSxPQUFPLEdBQUcsU0FBUyxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQTtJQUV2Qyx3Q0FBd0M7SUFDeEMsSUFBSSxPQUFPLENBQUMsTUFBTSxHQUFHLEVBQUU7UUFBRSxNQUFNLElBQUksU0FBUyxDQUFDLE9BQU8sR0FBRyxlQUFlLENBQUMsQ0FBQTtJQUN2RSxJQUFJLE9BQU8sQ0FBQyxNQUFNLEdBQUcsRUFBRTtRQUFFLE1BQU0sSUFBSSxTQUFTLENBQUMsT0FBTyxHQUFHLGNBQWMsQ0FBQyxDQUFBO0lBRXRFLElBQUksU0FBUyxHQUFHLE9BQU8sQ0FBQyxNQUFNLEtBQUssRUFBRSxDQUFBO0lBQ3JDLElBQUksTUFBTSxHQUFHLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUE7SUFFOUIsSUFBSSxPQUFPLEdBQUcsU0FBUyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUE7SUFDOUQsSUFBSSxJQUFJLEdBQUcsT0FBTyxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQTtJQUVoQyxPQUFPLEVBQUUsT0FBTyxFQUFFLE9BQU8sRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLENBQUE7QUFDekMsQ0FBQztBQUVELFNBQVMsVUFBVSxDQUFFLE9BQU87SUFDMUIsSUFBSSxNQUFNLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQTtJQUNuQyxJQUFJLElBQUksR0FBRyxNQUFNLENBQUMsU0FBUyxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUE7SUFFbEQsT0FBTztRQUNMLE9BQU8sRUFBRSxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztRQUN4QixNQUFNLEVBQUUsTUFBTSxDQUFDLE1BQU07UUFDckIsSUFBSSxFQUFFLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDO0tBQ3hCLENBQUE7QUFDSCxDQUFDO0FBRUQsU0FBUyxhQUFhLENBQUUsSUFBSSxFQUFFLE9BQU87SUFDbkMsU0FBUyxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLFVBQVUsRUFBRSxLQUFLLENBQUMsTUFBTSxDQUFDLEVBQUUsU0FBUyxDQUFDLENBQUE7SUFFakUsaUhBQWlIO0lBQ2pILDhDQUE4QztJQUM5QyxJQUFJLFNBQVMsR0FBRyxPQUFPLEdBQUcsSUFBSSxDQUFBO0lBQzlCLElBQUksSUFBSSxHQUFHLFNBQVMsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUE7SUFDOUIsSUFBSSxNQUFNLEdBQUcsU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQTtJQUU5QixJQUFJLE9BQU8sR0FBRyxNQUFNLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxDQUFBO0lBQ3RDLFNBQVMsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLGFBQWEsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxVQUFVLENBQUMsT0FBTyxFQUFFLENBQUMsQ0FBQyxDQUFBO0lBQzlFLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFLE1BQU0sQ0FBQyxDQUFBO0lBRTFCLE9BQU8sU0FBUyxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQTtBQUNsQyxDQUFDO0FBRUQsU0FBUyxRQUFRLENBQUUsSUFBSSxFQUFFLE9BQU8sRUFBRSxNQUFNO0lBQ3RDLElBQUksS0FBSyxHQUFHLE1BQU0sQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUE7SUFDaEMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsQ0FBQTtJQUV0QixPQUFPLE1BQU0sQ0FBQyxNQUFNLENBQUMsTUFBTSxFQUFFLEtBQUssQ0FBQyxDQUFBO0FBQ3JDLENBQUM7QUFFRCxTQUFTLGdCQUFnQixDQUFFLFlBQVksRUFBRSxPQUFPO0lBQzlDLE9BQU8sR0FBRyxPQUFPLElBQUksUUFBUSxDQUFDLE9BQU8sQ0FBQTtJQUVyQyxJQUFJLFVBQVUsQ0FBQyxVQUFVLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxZQUFZLENBQUM7UUFBRSxPQUFPLGFBQWEsQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLFlBQVksQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLEVBQUUsT0FBTyxDQUFDLFVBQVUsQ0FBQyxDQUFBO0lBQzFJLElBQUksVUFBVSxDQUFDLFVBQVUsQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLFlBQVksQ0FBQztRQUFFLE9BQU8sYUFBYSxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsWUFBWSxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsRUFBRSxPQUFPLENBQUMsVUFBVSxDQUFDLENBQUE7SUFDMUksSUFBSSxVQUFVLENBQUMsaUJBQWlCLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxZQUFZLENBQUM7UUFBRSxPQUFPLFFBQVEsQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLFlBQVksQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQTtJQUMzSSxJQUFJLFVBQVUsQ0FBQyxpQkFBaUIsQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLFlBQVksQ0FBQztRQUFFLE9BQU8sUUFBUSxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsWUFBWSxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFBO0lBRTNJLE1BQU0sSUFBSSxLQUFLLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxZQUFZLENBQUMsR0FBRywwQkFBMEIsQ0FBQyxDQUFBO0FBQzNFLENBQUM7QUFFRCxTQUFTLGNBQWMsQ0FBRSxPQUFPLEVBQUUsT0FBTztJQUN2QyxPQUFPLEdBQUcsT0FBTyxJQUFJLFFBQVEsQ0FBQyxPQUFPLENBQUE7SUFFckMsSUFBSSxNQUFNLENBQUE7SUFDVixJQUFJO1FBQ0YsTUFBTSxHQUFHLGVBQWUsQ0FBQyxPQUFPLENBQUMsQ0FBQTtLQUNsQztJQUFDLE9BQU8sQ0FBQyxFQUFFLEdBQUU7SUFFZCxJQUFJLE1BQU0sRUFBRTtRQUNWLElBQUksTUFBTSxDQUFDLE9BQU8sS0FBSyxPQUFPLENBQUMsVUFBVTtZQUFFLE9BQU8sVUFBVSxDQUFDLFVBQVUsQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQTtRQUNsRyxJQUFJLE1BQU0sQ0FBQyxPQUFPLEtBQUssT0FBTyxDQUFDLFVBQVU7WUFBRSxPQUFPLFVBQVUsQ0FBQyxVQUFVLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUE7S0FDbkc7U0FBTTtRQUNMLElBQUk7WUFDRixNQUFNLEdBQUcsVUFBVSxDQUFDLE9BQU8sQ0FBQyxDQUFBO1NBQzdCO1FBQUMsT0FBTyxDQUFDLEVBQUUsR0FBRTtRQUVkLElBQUksTUFBTSxFQUFFO1lBQ1YsSUFBSSxNQUFNLENBQUMsTUFBTSxLQUFLLE9BQU8sQ0FBQyxNQUFNO2dCQUFFLE1BQU0sSUFBSSxLQUFLLENBQUMsT0FBTyxHQUFHLHdCQUF3QixDQUFDLENBQUE7WUFDekYsSUFBSSxNQUFNLENBQUMsT0FBTyxLQUFLLENBQUMsRUFBRTtnQkFDeEIsSUFBSSxNQUFNLENBQUMsSUFBSSxDQUFDLE1BQU0sS0FBSyxFQUFFO29CQUFFLE9BQU8sVUFBVSxDQUFDLGlCQUFpQixDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFBO2dCQUM3RixJQUFJLE1BQU0sQ0FBQyxJQUFJLENBQUMsTUFBTSxLQUFLLEVBQUU7b0JBQUUsT0FBTyxVQUFVLENBQUMsaUJBQWlCLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUE7YUFDOUY7U0FDRjtLQUNGO0lBRUQsTUFBTSxJQUFJLEtBQUssQ0FBQyxPQUFPLEdBQUcseUJBQXlCLENBQUMsQ0FBQTtBQUN0RCxDQUFDO0FBRUQsTUFBTSxDQUFDLE9BQU8sR0FBRztJQUNmLGVBQWUsRUFBRSxlQUFlO0lBQ2hDLFVBQVUsRUFBRSxVQUFVO0lBQ3RCLGdCQUFnQixFQUFFLGdCQUFnQjtJQUNsQyxhQUFhLEVBQUUsYUFBYTtJQUM1QixRQUFRLEVBQUUsUUFBUTtJQUNsQixjQUFjLEVBQUUsY0FBYztDQUMvQixDQUFBIiwic291cmNlc0NvbnRlbnQiOlsidmFyIEJ1ZmZlciA9IHJlcXVpcmUoJ3NhZmUtYnVmZmVyJykuQnVmZmVyXG52YXIgYmVjaDMyID0gcmVxdWlyZSgnYmVjaDMyJylcbnZhciBiczU4Y2hlY2sgPSByZXF1aXJlKCdiczU4Y2hlY2snKVxudmFyIGJzY3JpcHQgPSByZXF1aXJlKCcuL3NjcmlwdCcpXG52YXIgYnRlbXBsYXRlcyA9IHJlcXVpcmUoJy4vdGVtcGxhdGVzJylcbnZhciBuZXR3b3JrcyA9IHJlcXVpcmUoJy4vbmV0d29ya3MnKVxudmFyIHR5cGVmb3JjZSA9IHJlcXVpcmUoJ3R5cGVmb3JjZScpXG52YXIgdHlwZXMgPSByZXF1aXJlKCcuL3R5cGVzJylcblxuZnVuY3Rpb24gZnJvbUJhc2U1OENoZWNrIChhZGRyZXNzKSB7XG4gIHZhciBwYXlsb2FkID0gYnM1OGNoZWNrLmRlY29kZShhZGRyZXNzKVxuXG4gIC8vIFRPRE86IDQuMC4wLCBtb3ZlIHRvIFwidG9PdXRwdXRTY3JpcHRcIlxuICBpZiAocGF5bG9hZC5sZW5ndGggPCAyMSkgdGhyb3cgbmV3IFR5cGVFcnJvcihhZGRyZXNzICsgJyBpcyB0b28gc2hvcnQnKVxuICBpZiAocGF5bG9hZC5sZW5ndGggPiAyMikgdGhyb3cgbmV3IFR5cGVFcnJvcihhZGRyZXNzICsgJyBpcyB0b28gbG9uZycpXG5cbiAgdmFyIG11bHRpYnl0ZSA9IHBheWxvYWQubGVuZ3RoID09PSAyMlxuICB2YXIgb2Zmc2V0ID0gbXVsdGlieXRlID8gMiA6IDFcblxuICB2YXIgdmVyc2lvbiA9IG11bHRpYnl0ZSA/IHBheWxvYWQucmVhZFVJbnQxNkJFKDApIDogcGF5bG9hZFswXVxuICB2YXIgaGFzaCA9IHBheWxvYWQuc2xpY2Uob2Zmc2V0KVxuXG4gIHJldHVybiB7IHZlcnNpb246IHZlcnNpb24sIGhhc2g6IGhhc2ggfVxufVxuXG5mdW5jdGlvbiBmcm9tQmVjaDMyIChhZGRyZXNzKSB7XG4gIHZhciByZXN1bHQgPSBiZWNoMzIuZGVjb2RlKGFkZHJlc3MpXG4gIHZhciBkYXRhID0gYmVjaDMyLmZyb21Xb3JkcyhyZXN1bHQud29yZHMuc2xpY2UoMSkpXG5cbiAgcmV0dXJuIHtcbiAgICB2ZXJzaW9uOiByZXN1bHQud29yZHNbMF0sXG4gICAgcHJlZml4OiByZXN1bHQucHJlZml4LFxuICAgIGRhdGE6IEJ1ZmZlci5mcm9tKGRhdGEpXG4gIH1cbn1cblxuZnVuY3Rpb24gdG9CYXNlNThDaGVjayAoaGFzaCwgdmVyc2lvbikge1xuICB0eXBlZm9yY2UodHlwZXMudHVwbGUodHlwZXMuSGFzaDE2MGJpdCwgdHlwZXMuVUludDE2KSwgYXJndW1lbnRzKVxuXG4gIC8vIFpjYXNoIGFkZHMgYW4gZXh0cmEgcHJlZml4IHJlc3VsdGluZyBpbiBhIGJpZ2dlciAoMjIgYnl0ZXMpIHBheWxvYWQuIFdlIGlkZW50aWZ5IHRoZW0gWmNhc2ggYnkgY2hlY2tpbmcgaWYgdGhlXG4gIC8vIHZlcnNpb24gaXMgbXVsdGlieXRlICgyIGJ5dGVzIGluc3RlYWQgb2YgMSlcbiAgdmFyIG11bHRpYnl0ZSA9IHZlcnNpb24gPiAweGZmXG4gIHZhciBzaXplID0gbXVsdGlieXRlID8gMjIgOiAyMVxuICB2YXIgb2Zmc2V0ID0gbXVsdGlieXRlID8gMiA6IDFcblxuICB2YXIgcGF5bG9hZCA9IEJ1ZmZlci5hbGxvY1Vuc2FmZShzaXplKVxuICBtdWx0aWJ5dGUgPyBwYXlsb2FkLndyaXRlVUludDE2QkUodmVyc2lvbiwgMCkgOiBwYXlsb2FkLndyaXRlVUludDgodmVyc2lvbiwgMClcbiAgaGFzaC5jb3B5KHBheWxvYWQsIG9mZnNldClcblxuICByZXR1cm4gYnM1OGNoZWNrLmVuY29kZShwYXlsb2FkKVxufVxuXG5mdW5jdGlvbiB0b0JlY2gzMiAoZGF0YSwgdmVyc2lvbiwgcHJlZml4KSB7XG4gIHZhciB3b3JkcyA9IGJlY2gzMi50b1dvcmRzKGRhdGEpXG4gIHdvcmRzLnVuc2hpZnQodmVyc2lvbilcblxuICByZXR1cm4gYmVjaDMyLmVuY29kZShwcmVmaXgsIHdvcmRzKVxufVxuXG5mdW5jdGlvbiBmcm9tT3V0cHV0U2NyaXB0IChvdXRwdXRTY3JpcHQsIG5ldHdvcmspIHtcbiAgbmV0d29yayA9IG5ldHdvcmsgfHwgbmV0d29ya3MuYml0Y29pblxuXG4gIGlmIChidGVtcGxhdGVzLnB1YktleUhhc2gub3V0cHV0LmNoZWNrKG91dHB1dFNjcmlwdCkpIHJldHVybiB0b0Jhc2U1OENoZWNrKGJzY3JpcHQuY29tcGlsZShvdXRwdXRTY3JpcHQpLnNsaWNlKDMsIDIzKSwgbmV0d29yay5wdWJLZXlIYXNoKVxuICBpZiAoYnRlbXBsYXRlcy5zY3JpcHRIYXNoLm91dHB1dC5jaGVjayhvdXRwdXRTY3JpcHQpKSByZXR1cm4gdG9CYXNlNThDaGVjayhic2NyaXB0LmNvbXBpbGUob3V0cHV0U2NyaXB0KS5zbGljZSgyLCAyMiksIG5ldHdvcmsuc2NyaXB0SGFzaClcbiAgaWYgKGJ0ZW1wbGF0ZXMud2l0bmVzc1B1YktleUhhc2gub3V0cHV0LmNoZWNrKG91dHB1dFNjcmlwdCkpIHJldHVybiB0b0JlY2gzMihic2NyaXB0LmNvbXBpbGUob3V0cHV0U2NyaXB0KS5zbGljZSgyLCAyMiksIDAsIG5ldHdvcmsuYmVjaDMyKVxuICBpZiAoYnRlbXBsYXRlcy53aXRuZXNzU2NyaXB0SGFzaC5vdXRwdXQuY2hlY2sob3V0cHV0U2NyaXB0KSkgcmV0dXJuIHRvQmVjaDMyKGJzY3JpcHQuY29tcGlsZShvdXRwdXRTY3JpcHQpLnNsaWNlKDIsIDM0KSwgMCwgbmV0d29yay5iZWNoMzIpXG5cbiAgdGhyb3cgbmV3IEVycm9yKGJzY3JpcHQudG9BU00ob3V0cHV0U2NyaXB0KSArICcgaGFzIG5vIG1hdGNoaW5nIEFkZHJlc3MnKVxufVxuXG5mdW5jdGlvbiB0b091dHB1dFNjcmlwdCAoYWRkcmVzcywgbmV0d29yaykge1xuICBuZXR3b3JrID0gbmV0d29yayB8fCBuZXR3b3Jrcy5iaXRjb2luXG5cbiAgdmFyIGRlY29kZVxuICB0cnkge1xuICAgIGRlY29kZSA9IGZyb21CYXNlNThDaGVjayhhZGRyZXNzKVxuICB9IGNhdGNoIChlKSB7fVxuXG4gIGlmIChkZWNvZGUpIHtcbiAgICBpZiAoZGVjb2RlLnZlcnNpb24gPT09IG5ldHdvcmsucHViS2V5SGFzaCkgcmV0dXJuIGJ0ZW1wbGF0ZXMucHViS2V5SGFzaC5vdXRwdXQuZW5jb2RlKGRlY29kZS5oYXNoKVxuICAgIGlmIChkZWNvZGUudmVyc2lvbiA9PT0gbmV0d29yay5zY3JpcHRIYXNoKSByZXR1cm4gYnRlbXBsYXRlcy5zY3JpcHRIYXNoLm91dHB1dC5lbmNvZGUoZGVjb2RlLmhhc2gpXG4gIH0gZWxzZSB7XG4gICAgdHJ5IHtcbiAgICAgIGRlY29kZSA9IGZyb21CZWNoMzIoYWRkcmVzcylcbiAgICB9IGNhdGNoIChlKSB7fVxuXG4gICAgaWYgKGRlY29kZSkge1xuICAgICAgaWYgKGRlY29kZS5wcmVmaXggIT09IG5ldHdvcmsuYmVjaDMyKSB0aHJvdyBuZXcgRXJyb3IoYWRkcmVzcyArICcgaGFzIGFuIGludmFsaWQgcHJlZml4JylcbiAgICAgIGlmIChkZWNvZGUudmVyc2lvbiA9PT0gMCkge1xuICAgICAgICBpZiAoZGVjb2RlLmRhdGEubGVuZ3RoID09PSAyMCkgcmV0dXJuIGJ0ZW1wbGF0ZXMud2l0bmVzc1B1YktleUhhc2gub3V0cHV0LmVuY29kZShkZWNvZGUuZGF0YSlcbiAgICAgICAgaWYgKGRlY29kZS5kYXRhLmxlbmd0aCA9PT0gMzIpIHJldHVybiBidGVtcGxhdGVzLndpdG5lc3NTY3JpcHRIYXNoLm91dHB1dC5lbmNvZGUoZGVjb2RlLmRhdGEpXG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgdGhyb3cgbmV3IEVycm9yKGFkZHJlc3MgKyAnIGhhcyBubyBtYXRjaGluZyBTY3JpcHQnKVxufVxuXG5tb2R1bGUuZXhwb3J0cyA9IHtcbiAgZnJvbUJhc2U1OENoZWNrOiBmcm9tQmFzZTU4Q2hlY2ssXG4gIGZyb21CZWNoMzI6IGZyb21CZWNoMzIsXG4gIGZyb21PdXRwdXRTY3JpcHQ6IGZyb21PdXRwdXRTY3JpcHQsXG4gIHRvQmFzZTU4Q2hlY2s6IHRvQmFzZTU4Q2hlY2ssXG4gIHRvQmVjaDMyOiB0b0JlY2gzMixcbiAgdG9PdXRwdXRTY3JpcHQ6IHRvT3V0cHV0U2NyaXB0XG59XG4iXX0=