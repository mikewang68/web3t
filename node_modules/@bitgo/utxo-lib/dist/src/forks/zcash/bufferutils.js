var __extends = (this && this.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();
var typeforce = require('typeforce');
var types = require('../../types');
var version = require('./version');
var _a = require('../../bufferutils'), BufferReader = _a.BufferReader, BufferWriter = _a.BufferWriter;
var NUM_JOINSPLITS_INPUTS = 2;
var NUM_JOINSPLITS_OUTPUTS = 2;
var NOTECIPHERTEXT_SIZE = 1 + 8 + 32 + 32 + 512 + 16;
var G1_PREFIX_MASK = 0x02;
var G2_PREFIX_MASK = 0x0a;
var ZcashBufferReader = /** @class */ (function (_super) {
    __extends(ZcashBufferReader, _super);
    function ZcashBufferReader(buffer, offset, txVersion) {
        var _this = _super.call(this, buffer, offset) || this;
        typeforce(types.maybe(types.Int32), txVersion);
        _this.txVersion = txVersion;
        return _this;
    }
    ZcashBufferReader.prototype.readInt64 = function () {
        var a = this.buffer.readUInt32LE(this.offset);
        var b = this.buffer.readInt32LE(this.offset + 4);
        b *= 0x100000000;
        this.offset += 8;
        return b + a;
    };
    ZcashBufferReader.prototype.readCompressedG1 = function () {
        var yLsb = this.readUInt8() & 1;
        var x = this.readSlice(32);
        return {
            x: x,
            yLsb: yLsb
        };
    };
    ZcashBufferReader.prototype.readCompressedG2 = function () {
        var yLsb = this.readUInt8() & 1;
        var x = this.readSlice(64);
        return {
            x: x,
            yLsb: yLsb
        };
    };
    ZcashBufferReader.prototype.readZKProof = function () {
        var zkproof;
        if (this.txVersion >= version.SAPLING) {
            zkproof = {
                sA: this.readSlice(48),
                sB: this.readSlice(96),
                sC: this.readSlice(48)
            };
        }
        else {
            zkproof = {
                gA: this.readCompressedG1(),
                gAPrime: this.readCompressedG1(),
                gB: this.readCompressedG2(),
                gBPrime: this.readCompressedG1(),
                gC: this.readCompressedG1(),
                gCPrime: this.readCompressedG1(),
                gK: this.readCompressedG1(),
                gH: this.readCompressedG1()
            };
        }
        return zkproof;
    };
    ZcashBufferReader.prototype.readJoinSplit = function () {
        var vpubOld = this.readUInt64();
        var vpubNew = this.readUInt64();
        var anchor = this.readSlice(32);
        var nullifiers = [];
        for (var j = 0; j < NUM_JOINSPLITS_INPUTS; j++) {
            nullifiers.push(this.readSlice(32));
        }
        var commitments = [];
        for (j = 0; j < NUM_JOINSPLITS_OUTPUTS; j++) {
            commitments.push(this.readSlice(32));
        }
        var ephemeralKey = this.readSlice(32);
        var randomSeed = this.readSlice(32);
        var macs = [];
        for (j = 0; j < NUM_JOINSPLITS_INPUTS; j++) {
            macs.push(this.readSlice(32));
        }
        var zkproof = this.readZKProof();
        var ciphertexts = [];
        for (j = 0; j < NUM_JOINSPLITS_OUTPUTS; j++) {
            ciphertexts.push(this.readSlice(NOTECIPHERTEXT_SIZE));
        }
        return {
            vpubOld: vpubOld,
            vpubNew: vpubNew,
            anchor: anchor,
            nullifiers: nullifiers,
            commitments: commitments,
            ephemeralKey: ephemeralKey,
            randomSeed: randomSeed,
            macs: macs,
            zkproof: zkproof,
            ciphertexts: ciphertexts
        };
    };
    ZcashBufferReader.prototype.readShieldedSpend = function () {
        var cv = this.readSlice(32);
        var anchor = this.readSlice(32);
        var nullifier = this.readSlice(32);
        var rk = this.readSlice(32);
        var zkproof = this.readZKProof();
        var spendAuthSig = this.readSlice(64);
        return {
            cv: cv,
            anchor: anchor,
            nullifier: nullifier,
            rk: rk,
            zkproof: zkproof,
            spendAuthSig: spendAuthSig
        };
    };
    ZcashBufferReader.prototype.readShieldedOutput = function () {
        var cv = this.readSlice(32);
        var cmu = this.readSlice(32);
        var ephemeralKey = this.readSlice(32);
        var encCiphertext = this.readSlice(580);
        var outCiphertext = this.readSlice(80);
        var zkproof = this.readZKProof();
        return {
            cv: cv,
            cmu: cmu,
            ephemeralKey: ephemeralKey,
            encCiphertext: encCiphertext,
            outCiphertext: outCiphertext,
            zkproof: zkproof
        };
    };
    return ZcashBufferReader;
}(BufferReader));
var ZcashBufferWriter = /** @class */ (function (_super) {
    __extends(ZcashBufferWriter, _super);
    function ZcashBufferWriter() {
        return _super !== null && _super.apply(this, arguments) || this;
    }
    ZcashBufferWriter.prototype.writeCompressedG1 = function (i) {
        this.writeUInt8(G1_PREFIX_MASK | i.yLsb);
        this.writeSlice(i.x);
    };
    ZcashBufferWriter.prototype.writeCompressedG2 = function (i) {
        this.writeUInt8(G2_PREFIX_MASK | i.yLsb);
        this.writeSlice(i.x);
    };
    return ZcashBufferWriter;
}(BufferWriter));
module.exports = { ZcashBufferReader: ZcashBufferReader, ZcashBufferWriter: ZcashBufferWriter };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYnVmZmVydXRpbHMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvZm9ya3MvemNhc2gvYnVmZmVydXRpbHMuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7O0FBQUEsSUFBTSxTQUFTLEdBQUcsT0FBTyxDQUFDLFdBQVcsQ0FBQyxDQUFBO0FBQ3RDLElBQU0sS0FBSyxHQUFHLE9BQU8sQ0FBQyxhQUFhLENBQUMsQ0FBQTtBQUNwQyxJQUFNLE9BQU8sR0FBRyxPQUFPLENBQUMsV0FBVyxDQUFDLENBQUE7QUFFOUIsSUFBQSxLQUFpQyxPQUFPLENBQUMsbUJBQW1CLENBQUMsRUFBM0QsWUFBWSxrQkFBQSxFQUFFLFlBQVksa0JBQWlDLENBQUE7QUFFbkUsSUFBTSxxQkFBcUIsR0FBRyxDQUFDLENBQUE7QUFDL0IsSUFBTSxzQkFBc0IsR0FBRyxDQUFDLENBQUE7QUFDaEMsSUFBTSxtQkFBbUIsR0FBRyxDQUFDLEdBQUcsQ0FBQyxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsR0FBRyxHQUFHLEVBQUUsQ0FBQTtBQUV0RCxJQUFNLGNBQWMsR0FBRyxJQUFJLENBQUE7QUFDM0IsSUFBTSxjQUFjLEdBQUcsSUFBSSxDQUFBO0FBRTNCO0lBQWdDLHFDQUFZO0lBQzFDLDJCQUFhLE1BQU0sRUFBRSxNQUFNLEVBQUUsU0FBUztRQUF0QyxZQUNFLGtCQUFNLE1BQU0sRUFBRSxNQUFNLENBQUMsU0FHdEI7UUFGQyxTQUFTLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLEVBQUUsU0FBUyxDQUFDLENBQUE7UUFDOUMsS0FBSSxDQUFDLFNBQVMsR0FBRyxTQUFTLENBQUE7O0lBQzVCLENBQUM7SUFFRCxxQ0FBUyxHQUFUO1FBQ0UsSUFBTSxDQUFDLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFBO1FBQy9DLElBQUksQ0FB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LENBQUMsSUFBSSxDQUFDLENBQUE7UUFDeEMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUE7SUFDdEIsQ0FBQztJQUVELDZDQUFpQixHQUFqQixVQUFtQixDQUFDO1FBQ2xCLElBQUksQ0FBQyxVQUFVLENBQUMsY0FBYyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQTtRQUN4QyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQTtJQUN0QixDQUFDO0lBQ0gsd0JBQUM7QUFBRCxDQUFDLEFBVkQsQ0FBZ0MsWUFBWSxHQVUzQztBQUVELE1BQU0sQ0FBQyxPQUFPLEdBQUcsRUFBRSxpQkFBaUIsbUJBQUEsRUFBRSxpQkFBaUIsbUJBQUEsRUFBRSxDQUFBIiwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgdHlwZWZvcmNlID0gcmVxdWlyZSgndHlwZWZvcmNlJylcbmNvbnN0IHR5cGVzID0gcmVxdWlyZSgnLi4vLi4vdHlwZXMnKVxuY29uc3QgdmVyc2lvbiA9IHJlcXVpcmUoJy4vdmVyc2lvbicpXG5cbmNvbnN0IHsgQnVmZmVyUmVhZGVyLCBCdWZmZXJXcml0ZXIgfSA9IHJlcXVpcmUoJy4uLy4uL2J1ZmZlcnV0aWxzJylcblxuY29uc3QgTlVNX0pPSU5TUExJVFNfSU5QVVRTID0gMlxuY29uc3QgTlVNX0pPSU5TUExJVFNfT1VUUFVUUyA9IDJcbmNvbnN0IE5PVEVDSVBIRVJURVhUX1NJWkUgPSAxICsgOCArIDMyICsgMzIgKyA1MTIgKyAxNlxuXG5jb25zdCBHMV9QUkVGSVhfTUFTSyA9IDB4MDJcbmNvbnN0IEcyX1BSRUZJWF9NQVNLID0gMHgwYVxuXG5jbGFzcyBaY2FzaEJ1ZmZlclJlYWRlciBleHRlbmRzIEJ1ZmZlclJlYWRlciB7XG4gIGNvbnN0cnVjdG9yIChidWZmZXIsIG9mZnNldCwgdHhWZXJzaW9uKSB7XG4gICAgc3VwZXIoYnVmZmVyLCBvZmZzZXQpXG4gICAgdHlwZWZvcmNlKHR5cGVzLm1heWJlKHR5cGVzLkludDMyKSwgdHhWZXJzaW9uKVxuICAgIHRoaXMudHhWZXJzaW9uID0gdHhWZXJzaW9uXG4gIH1cblxuICByZWFkSW50NjQgKCkge1xuICAgIGNvbnN0IGEgPSB0aGlzLmJ1ZmZlci5yZWFkVUludDMyTEUodGhpcy5vZmZzZXQpXG4gICAgbGV0IGIgPSB0aGlzLmJ1ZmZlci5yZWFkSW50MzJMRSh0aGlzLm9mZnNldCArIDQpXG4gICAgYiAqPSAweDEwMDAwMDAwMFxuICAgIHRoaXMub2Zmc2V0ICs9IDhcbiAgICByZXR1cm4gYiArIGFcbiAgfVxuXG4gIHJlYWRDb21wcmVzc2VkRzEgKCkge1xuICAgIHZhciB5THNiID0gdGhpcy5yZWFkVUludDgoKSAmIDFcbiAgICB2YXIgeCA9IHRoaXMucmVhZFNsaWNlKDMyKVxuICAgIHJldHVybiB7XG4gICAgICB4OiB4LFxuICAgICAgeUxzYjogeUxzYlxuICAgIH1cbiAgfVxuXG4gIHJlYWRDb21wcmVzc2VkRzIgKCkge1xuICAgIHZhciB5THNiID0gdGhpcy5yZWFkVUludDgoKSAmIDFcbiAgICB2YXIgeCA9IHRoaXMucmVhZFNsaWNlKDY0KVxuICAgIHJldHVybiB7XG4gICAgICB4OiB4LFxuICAgICAgeUxzYjogeUxzYlxuICAgIH1cbiAgfVxuXG4gIHJlYWRaS1Byb29mICgpIHtcbiAgICB2YXIgemtwcm9vZlxuICAgIGlmICh0aGlzLnR4VmVyc2lvbiA+PSB2ZXJzaW9uLlNBUExJTkcpIHtcbiAgICAgIHprcHJvb2YgPSB7XG4gICAgICAgIHNBOiB0aGlzLnJlYWRTbGljZSg0OCksXG4gICAgICAgIHNCOiB0aGlzLnJlYWRTbGljZSg5NiksXG4gICAgICAgIHNDOiB0aGlzLnJlYWRTbGljZSg0OClcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgemtwcm9vZiA9IHtcbiAgICAgICAgZ0E6IHRoaXMucmVhZENvbXByZXNzZWRHMSgpLFxuICAgICAgICBnQVByaW1lOiB0aGlzLnJlYWRDb21wcmVzc2VkRzEoKSxcbiAgICAgICAgZ0I6IHRoaXMucmVhZENvbXByZXNzZWRHMigpLFxuICAgICAgICBnQlByaW1lOiB0aGlzLnJlYWRDb21wcmVzc2VkRzEoKSxcbiAgICAgICAgZ0M6IHRoaXMucmVhZENvbXByZXNzZWRHMSgpLFxuICAgICAgICBnQ1ByaW1lOiB0aGlzLnJlYWRDb21wcmVzc2VkRzEoKSxcbiAgICAgICAgZ0s6IHRoaXMucmVhZENvbXByZXNzZWRHMSgpLFxuICAgICAgICBnSDogdGhpcy5yZWFkQ29tcHJlc3NlZEcxKClcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHprcHJvb2ZcbiAgfVxuXG4gIHJlYWRKb2luU3BsaXQgKCkge1xuICAgIHZhciB2cHViT2xkID0gdGhpcy5yZWFkVUludDY0KClcbiAgICB2YXIgdnB1Yk5ldyA9IHRoaXMucmVhZFVJbnQ2NCgpXG4gICAgdmFyIGFuY2hvciA9IHRoaXMucmVhZFNsaWNlKDMyKVxuICAgIHZhciBudWxsaWZpZXJzID0gW11cbiAgICBmb3IgKHZhciBqID0gMDsgaiA8IE5VTV9KT0lOU1BMSVRTX0lOUFVUUzsgaisrKSB7XG4gICAgICBudWxsaWZpZXJzLnB1c2godGhpcy5yZWFkU2xpY2UoMzIpKVxuICAgIH1cbiAgICB2YXIgY29tbWl0bWVudHMgPSBbXVxuICAgIGZvciAoaiA9IDA7IGogPCBOVU1fSk9JTlNQTElUU19PVVRQVVRTOyBqKyspIHtcbiAgICAgIGNvbW1pdG1lbnRzLnB1c2godGhpcy5yZWFkU2xpY2UoMzIpKVxuICAgIH1cbiAgICB2YXIgZXBoZW1lcmFsS2V5ID0gdGhpcy5yZWFkU2xpY2UoMzIpXG4gICAgdmFyIHJhbmRvbVNlZWQgPSB0aGlzLnJlYWRTbGljZSgzMilcbiAgICB2YXIgbWFjcyA9IFtdXG4gICAgZm9yIChqID0gMDsgaiA8IE5VTV9KT0lOU1BMSVRTX0lOUFVUUzsgaisrKSB7XG4gICAgICBtYWNzLnB1c2godGhpcy5yZWFkU2xpY2UoMzIpKVxuICAgIH1cblxuICAgIHZhciB6a3Byb29mID0gdGhpcy5yZWFkWktQcm9vZigpXG4gICAgdmFyIGNpcGhlcnRleHRzID0gW11cbiAgICBmb3IgKGogPSAwOyBqIDwgTlVNX0pPSU5TUExJVFNfT1VUUFVUUzsgaisrKSB7XG4gICAgICBjaXBoZXJ0ZXh0cy5wdXNoKHRoaXMucmVhZFNsaWNlKE5PVEVDSVBIRVJURVhUX1NJWkUpKVxuICAgIH1cbiAgICByZXR1cm4ge1xuICAgICAgdnB1Yk9sZDogdnB1Yk9sZCxcbiAgICAgIHZwdWJOZXc6IHZwdWJOZXcsXG4gICAgICBhbmNob3I6IGFuY2hvcixcbiAgICAgIG51bGxpZmllcnM6IG51bGxpZmllcnMsXG4gICAgICBjb21taXRtZW50czogY29tbWl0bWVudHMsXG4gICAgICBlcGhlbWVyYWxLZXk6IGVwaGVtZXJhbEtleSxcbiAgICAgIHJhbmRvbVNlZWQ6IHJhbmRvbVNlZWQsXG4gICAgICBtYWNzOiBtYWNzLFxuICAgICAgemtwcm9vZjogemtwcm9vZixcbiAgICAgIGNpcGhlcnRleHRzOiBjaXBoZXJ0ZXh0c1xuICAgIH1cbiAgfVxuXG4gIHJlYWRTaGllbGRlZFNwZW5kICgpIHtcbiAgICB2YXIgY3YgPSB0aGlzLnJlYWRTbGljZSgzMilcbiAgICB2YXIgYW5jaG9yID0gdGhpcy5yZWFkU2xpY2UoMzIpXG4gICAgdmFyIG51bGxpZmllciA9IHRoaXMucmVhZFNsaWNlKDMyKVxuICAgIHZhciByayA9IHRoaXMucmVhZFNsaWNlKDMyKVxuICAgIHZhciB6a3Byb29mID0gdGhpcy5yZWFkWktQcm9vZigpXG4gICAgdmFyIHNwZW5kQXV0aFNpZyA9IHRoaXMucmVhZFNsaWNlKDY0KVxuICAgIHJldHVybiB7XG4gICAgICBjdjogY3YsXG4gICAgICBhbmNob3I6IGFuY2hvcixcbiAgICAgIG51bGxpZmllcjogbnVsbGlmaWVyLFxuICAgICAgcms6IHJrLFxuICAgICAgemtwcm9vZjogemtwcm9vZixcbiAgICAgIHNwZW5kQXV0aFNpZzogc3BlbmRBdXRoU2lnXG4gICAgfVxuICB9XG5cbiAgcmVhZFNoaWVsZGVkT3V0cHV0ICgpIHtcbiAgICB2YXIgY3YgPSB0aGlzLnJlYWRTbGljZSgzMilcbiAgICB2YXIgY211ID0gdGhpcy5yZWFkU2xpY2UoMzIpXG4gICAgdmFyIGVwaGVtZXJhbEtleSA9IHRoaXMucmVhZFNsaWNlKDMyKVxuICAgIHZhciBlbmNDaXBoZXJ0ZXh0ID0gdGhpcy5yZWFkU2xpY2UoNTgwKVxuICAgIHZhciBvdXRDaXBoZXJ0ZXh0ID0gdGhpcy5yZWFkU2xpY2UoODApXG4gICAgdmFyIHprcHJvb2YgPSB0aGlzLnJlYWRaS1Byb29mKClcblxuICAgIHJldHVybiB7XG4gICAgICBjdjogY3YsXG4gICAgICBjbXU6IGNtdSxcbiAgICAgIGVwaGVtZXJhbEtleTogZXBoZW1lcmFsS2V5LFxuICAgICAgZW5jQ2lwaGVydGV4dDogZW5jQ2lwaGVydGV4dCxcbiAgICAgIG91dENpcGhlcnRleHQ6IG91dENpcGhlcnRleHQsXG4gICAgICB6a3Byb29mOiB6a3Byb29mXG4gICAgfVxuICB9XG59XG5cbmNsYXNzIFpjYXNoQnVmZmVyV3JpdGVyIGV4dGVuZHMgQnVmZmVyV3JpdGVyIHtcbiAgd3JpdGVDb21wcmVzc2VkRzEgKGkpIHtcbiAgICB0aGlzLndyaXRlVUludDgoRzFfUFJFRklYX01BU0sgfCBpLnlMc2IpXG4gICAgdGhpcy53cml0ZVNsaWNlKGkueClcbiAgfVxuXG4gIHdyaXRlQ29tcHJlc3NlZEcyIChpKSB7XG4gICAgdGhpcy53cml0ZVVJbnQ4KEcyX1BSRUZJWF9NQVNLIHwgaS55THNiKVxuICAgIHRoaXMud3JpdGVTbGljZShpLngpXG4gIH1cbn1cblxubW9kdWxlLmV4cG9ydHMgPSB7IFpjYXNoQnVmZmVyUmVhZGVyLCBaY2FzaEJ1ZmZlcldyaXRlciB9XG4iXX0=